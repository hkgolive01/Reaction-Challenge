<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reaction Challenge</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2ed573;
            --secondary-color: #ff4757;
            --bg-color: #f0f2f5;
            --text-color: #2f3542;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px; /* å·¦å³ç•™ä¸€é»ç·©è¡ */
            box-sizing: border-box;
        }

        h1, h2, h3 {
            margin: 0.5em 0;
            text-align: center;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 480px; /* é™åˆ¶æ•´é«”å¯¬åº¦ */
        }

        .status-bar {
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #57606f;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 9å®®æ ¼å®¹å™¨ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background-color: #dfe4ea;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1 / 1;
            margin-bottom: 20px;
        }

        /* å–®å€‹æ ¼å­ */
        .cell {
            background-color: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.15s;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .cell:active { transform: scale(0.92); }

        .cell.active {
            background-color: var(--secondary-color);
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.7);
            border: 2px solid #fff;
        }

        .controls {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #start-btn { background-color: var(--primary-color); color: white; }
        #start-btn:hover { background-color: #26af61; transform: translateY(-2px); }
        #start-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none;}

        #screenshot-btn {
            background-color: #3742fa;
            color: white;
            margin-top: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            max-width: 300px;
        }
        #screenshot-btn:hover { background-color: #2f3542; }

        /* --- æˆªåœ–å€åŸŸæ¨£å¼ä¿®æ­£ --- */
        #capture-area {
            width: 100%;
            /* é€™è£¡è¨­å®š padding å’Œ border-box å¾ˆé‡è¦ï¼Œé˜²æ­¢å…§å®¹è²¼é‚Šè¢«åˆ‡æ‰ */
            box-sizing: border-box; 
            padding: 20px;
            background-color: var(--bg-color); 
            border-radius: 10px;
        }

        .results-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’ç ´å¯¬åº¦ */
            margin-bottom: 20px;
        }

        /* é è¨­éš±è—æœ¬æ¬¡çµæœ */
        #current-result-board { display: none; }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f2f6;
            font-feature-settings: "tnum";
        }

        /* ç”¨æ–¼æ¨™è¨˜è¢«å‰”é™¤çš„æœ€é«˜/æœ€ä½åˆ† (æ¨£å¼å¯é¸) */
        .result-item.excluded {
            color: #b2bec3;
            text-decoration: line-through;
            font-size: 0.9em;
        }
        
        .average-score-box {
            margin-top: 15px;
            padding: 15px;
            background-color: #f1f2f6;
            border-radius: 10px;
            text-align: center;
        }
        .average-score-box strong { color: var(--secondary-color); font-size: 1.5em; }
        .average-note { font-size: 0.8rem; color: #747d8c; margin-top: 5px; }

        /* æ’è¡Œæ¦œ */
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .rank-num { font-weight: bold; width: 30px; color: #747d8c; }
        .rank-1 .rank-num { color: #ffd32a; font-size: 1.1em; }
        .rank-2 .rank-num { color: #d2d6de; font-size: 1.05em; }
        .rank-3 .rank-num { color: #ff7f50; font-size: 1.05em; }

        .rank-time { font-weight: bold; color: var(--text-color); }
        .rank-date { font-size: 0.75rem; color: #a4b0be; }

    </style>
</head>
<body>

<div class="main-container">
    <h1>âš¡ åæ‡‰åŠ›æŒ‘æˆ° âš¡</h1>
    
    <div class="status-bar" id="status-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>

    <div class="grid-container" id="grid"></div>

    <div class="controls">
        <button id="start-btn" class="btn" onclick="startGame()">é–‹å§‹æ¸¬è©¦</button>
    </div>

    <div id="capture-area">
        <div id="current-result-board" class="results-container">
            <h3>æœ¬æ¬¡æ¸¬è©¦çµæœ</h3>
            <div id="result-list"></div>
            <div class="average-score-box" id="average-score"></div>
        </div>

        <div id="leaderboard-board" class="results-container">
            <h3>ğŸ† æ­·å² TOP 10</h3>
            <ul id="leaderboard-list" class="leaderboard-list"></ul>
        </div>
        
        <div style="text-align: center; font-size: 0.8rem; color: #999; margin-top: 10px;">
            Challenge your reaction speed!
        </div>
    </div>

    <button id="screenshot-btn" class="btn" style="display: none;" onclick="takeScreenshot()">
        ğŸ“¸ æˆªåœ–æˆç¸¾å–® (è¤‡è£½åˆ°å‰ªè²¼ç°¿)
    </button>
</div>

<script>
    // --- è®Šæ•¸èˆ‡ DOM ---
    const gridContainer = document.getElementById('grid');
    const statusText = document.getElementById('status-text');
    const startBtn = document.getElementById('start-btn');
    const currentResultBoard = document.getElementById('current-result-board');
    const resultList = document.getElementById('result-list');
    const averageScoreDiv = document.getElementById('average-score');
    const leaderboardList = document.getElementById('leaderboard-list');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const captureArea = document.getElementById('capture-area');

    // ä¿®æ”¹: ç¸½å›åˆæ•¸æ”¹ç‚º 7
    const TOTAL_ROUNDS = 7;
    let currentRound = 0;
    let reactionTimes = [];
    let startTime = 0;
    let isWaitingForClick = false;
    let activeCellIndex = -1;
    let timer = null;
    // æ›´æ”¹ Key ä»¥å€éš”èˆŠç‰ˆæˆç¸¾ (å› ç‚ºè¨ˆç®—æ–¹å¼ä¸åŒäº†)
    const STORAGE_KEY = 'reaction_game_scores_v2_trimmed'; 

    // --- åˆå§‹åŒ– ---
    function init() {
        initGrid();
        renderLeaderboard();
    }

    function initGrid() {
        gridContainer.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            let cell = document.createElement('div');
            cell.classList.add('cell');
            cell.addEventListener('pointerdown', (e) => {
                e.preventDefault(); 
                handleCellClick(i);
            });
            gridContainer.appendChild(cell);
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function startGame() {
        currentRound = 0;
        reactionTimes = [];
        startBtn.disabled = true;
        startBtn.textContent = "æ¸¬è©¦é€²è¡Œä¸­...";
        currentResultBoard.style.display = 'none';
        screenshotBtn.style.display = 'none';
        
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
        nextRound();
    }

    function nextRound() {
        if (currentRound >= TOTAL_ROUNDS) {
            endGame();
            return;
        }
        currentRound++;
        statusText.innerHTML = `<span style="color:#747d8c">Round ${currentRound}/${TOTAL_ROUNDS}</span> - ç­‰å¾…äº®ç‡ˆ...`;
        isWaitingForClick = false;
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));

        const randomDelay = Math.floor(Math.random() * 1700) + 800;
        timer = setTimeout(activateRandomCell, randomDelay);
    }

    function activateRandomCell() {
        const cells = document.querySelectorAll('.cell');
        let randomIndex;
        do { randomIndex = Math.floor(Math.random() * 9); } 
        while (randomIndex === activeCellIndex && Math.random() > 0.5);
        
        activeCellIndex = randomIndex;
        cells[randomIndex].classList.add('active');
        startTime = performance.now();
        isWaitingForClick = true;
        statusText.innerHTML = `<span style="color: var(--secondary-color)">ğŸ”¥ å¿«æŒ‰! ğŸ”¥</span>`;
    }

    function handleCellClick(index) {
        if (!isWaitingForClick) return;
        if (index === activeCellIndex) {
            const endTime = performance.now();
            const reactionTime = Math.round(endTime - startTime);
            reactionTimes.push(reactionTime);
            isWaitingForClick = false;
            document.querySelectorAll('.cell')[activeCellIndex].classList.remove('active');
            statusText.textContent = `${reactionTime} ms`;
            setTimeout(nextRound, 400);
        }
    }

    function endGame() {
        startBtn.disabled = false;
        startBtn.textContent = "å†æ¬¡æŒ‘æˆ°";
        statusText.innerHTML = "ğŸ‰ æ¸¬è©¦å®Œæˆ!";
        showCurrentResults();
        saveAndUpdateLeaderboard();
        screenshotBtn.style.display = 'flex';
        // ç‚ºäº†è®“ä½¿ç”¨è€…çœ‹åˆ°çµæœï¼Œå¹³æ»‘æ»¾å‹•
        currentResultBoard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- æ–°å¢è¨ˆç®—é‚è¼¯: å»é ­å»å°¾å¹³å‡ ---
    function calculateTrimmedScore(times) {
        if (times.length < 3) return { avg: 0, minIdx: -1, maxIdx: -1 };
        
        // æ‰¾å‡ºæœ€å¤§å€¼å’Œæœ€å°å€¼çš„ç´¢å¼• (å¦‚æœæœ‰å¤šå€‹ç›¸åŒå€¼ï¼Œé€™è£¡åªæŠ“ç¬¬ä¸€å€‹é‡åˆ°çš„)
        let minVal = Math.min(...times);
        let maxVal = Math.max(...times);
        
        // ç‚ºäº†åœ¨åˆ—è¡¨ä¸­æ¨™ç¤ºï¼Œæˆ‘å€‘éœ€è¦å…·é«”çš„ index
        // æ³¨æ„ï¼šé€™è£¡åªæœƒæ¨™è¨˜ç¬¬ä¸€å€‹å‡ºç¾çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
        let minIdx = times.indexOf(minVal);
        let maxIdx = times.indexOf(maxVal);

        // è¤‡è£½ä¸€ä»½é™£åˆ—é€²è¡Œæ’åºè¨ˆç®—
        let sorted = [...times].sort((a, b) => a - b);
        // å»æ‰é ­å°¾
        let trimmed = sorted.slice(1, sorted.length - 1);
        let total = trimmed.reduce((a, b) => a + b, 0);
        let avg = Math.round(total / trimmed.length);

        return { avg, minIdx, maxIdx };
    }

    function showCurrentResults() {
        currentResultBoard.style.display = 'block';
        resultList.innerHTML = '';
        
        // å–å¾—è¨ˆç®—çµæœ
        const { avg, minIdx, maxIdx } = calculateTrimmedScore(reactionTimes);

        reactionTimes.forEach((time, index) => {
            const item = document.createElement('div');
            item.classList.add('result-item');
            
            // æ¨™è¨˜æœ€é«˜å’Œæœ€ä½åˆ† (è¦–è¦ºä¸Šè®Šç°æˆ–åˆªé™¤ç·š)
            let isExcluded = (index === minIdx || index === maxIdx);
            if (isExcluded) {
                item.classList.add('excluded');
            }

            let roundText = `Round ${index + 1}`;
            if (index === minIdx) roundText += " (æœ€å¿«)";
            if (index === maxIdx) roundText += " (æœ€æ…¢)";

            item.innerHTML = `<span>${roundText}</span> <span>${time} ms</span>`;
            resultList.appendChild(item);
        });

        averageScoreDiv.innerHTML = `
            å¹³å‡åæ‡‰æ™‚é–“<br>
            <strong>${avg} ms</strong>
            <div class="average-note">(å»é™¤æœ€å¿«èˆ‡æœ€æ…¢æˆç¸¾)</div>
        `;
    }

    // --- æ’è¡Œæ¦œ (LocalStorage) ---
    function formatDateTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function saveAndUpdateLeaderboard() {
        // ä½¿ç”¨ç›¸åŒçš„å»é ­å»å°¾é‚è¼¯è¨ˆç®—åˆ†æ•¸
        const { avg } = calculateTrimmedScore(reactionTimes);
        
        const newScore = { avgTime: avg, timestamp: new Date().getTime() };
        let scores = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        scores.push(newScore);
        scores.sort((a, b) => a.avgTime - b.avgTime);
        scores = scores.slice(0, 10);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
        renderLeaderboard();
    }

    function renderLeaderboard() {
        const scores = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        leaderboardList.innerHTML = '';
        if (scores.length === 0) {
            leaderboardList.innerHTML = '<li style="text-align:center; padding:10px; color:#999;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°!</li>';
            return;
        }
        scores.forEach((score, index) => {
            const li = document.createElement('li');
            li.classList.add('leaderboard-item', `rank-${index + 1}`);
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="rank-num">${index + 1}.</span>
                    <span class="rank-time">${score.avgTime} ms</span>
                </div>
                <span class="rank-date">${formatDateTime(score.timestamp)}</span>
            `;
            leaderboardList.appendChild(li);
        });
    }

    // --- æˆªåœ–åŠŸèƒ½ (ä¿®æ­£ç‰ˆ) ---
    async function takeScreenshot() {
        const originalBtnText = screenshotBtn.innerHTML;
        screenshotBtn.innerHTML = 'â³ è™•ç†ä¸­...';
        screenshotBtn.disabled = true;

        try {
            const canvas = await html2canvas(captureArea, {
                scale: 2, 
                backgroundColor: '#f0f2f5', 
                useCORS: true,
                width: captureArea.scrollWidth, 
                height: captureArea.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                x: 0, 
                y: 0
            });

            canvas.toBlob(async (blob) => {
                if (!blob) throw new Error('Canvas Error');
                
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        const item = new ClipboardItem({ 'image/png': blob });
                        await navigator.clipboard.write([item]);
                        screenshotBtn.innerHTML = 'âœ… å·²è¤‡è£½!';
                    } catch (err) {
                        fallbackDownload(canvas);
                    }
                } else {
                    fallbackDownload(canvas);
                }
                
                setTimeout(() => {
                    screenshotBtn.innerHTML = originalBtnText;
                    screenshotBtn.disabled = false;
                }, 3000);

            }, 'image/png');

        } catch (err) {
            console.error('Screenshot failed:', err);
            screenshotBtn.innerHTML = 'âŒ å¤±æ•—';
            screenshotBtn.disabled = false;
        }
    }

    function fallbackDownload(canvas) {
        const link = document.createElement('a');
        link.download = `åæ‡‰åŠ›æˆç¸¾_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        screenshotBtn.innerHTML = 'âœ… å·²ä¸‹è¼‰åœ–ç‰‡';
    }

    init();
</script>
</body>
</html>
